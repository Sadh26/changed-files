name: CI

on:
  pull_request:
    branches:
      - main

  workflow_dispatch:

jobs:
  # ------------------------------------------------------------------------------------------------------------------------------------------------
  # Event `pull_request`: Compare the last commit of the main branch or last remote commit of the PR branch -> to the current commit of a PR branch.
  # ------------------------------------------------------------------------------------------------------------------------------------------------
  changed_files:
    runs-on: self-hosted
    name: Test changed-files
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0  # OR "2" -> To retrieve the preceding commit.

      - name: Get changed files in the src folder
        id: changed-files-specific
        uses: tj-actions/changed-files@v37
        with:
          files: src/**/*.vi  # Alternatively using: `docs/**` or `docs`
          separator: ","          

      - name: Run Tests
        run: |
            # Function to find test vi files
            function Find-ViFiles {
                param (
                    [string]$path
                )
                Get-ChildItem $path -Recurse | ForEach-Object {
                    if ($_.PSIsContainer) {
                        Find-ViFiles $_.FullName
                    }
                    elseif ($_.Extension -eq ".vi") {
                        $isFileExist = $true
                        Write-Output ("`n`nFound .vi file: " + $_.FullName)
                        Write-Output ("Running unit test file " + $_.FullName)
                        $output = g-cli --lv-ver 2020 $_.FullName
                        Write-Output ("$output")
                        if ($output -ne $null) {
                          $errorIn = "true"
                        }
                    }
                }
                if ($isFileExist -eq $false) {
                  Write-Output "No test files found"
                }
                if ($errorIn -eq "true") {
                  return $true
                }
                else {
                  return $false
                }
            }      

            echo "One or more files in the src folder has changed."
            echo "List all the files that have changed: ${{ steps.changed-files-specific.outputs.all_changed_files }}"

            $workspace = "${{ github.workspace }}"
            $workspace_path = $workspace.Replace("\", "/")

            $changed_file = "${{ steps.changed-files-specific.outputs.all_changed_files }}"
            $changedFiles = $changed_file -split ',' 

            $isFileExist = $false
            $flag = $false
            $listOfLvfiles = @()
            $uniqueList = @()

             foreach ($file in $changedFiles)
             {
                $flag = $false
                while ($flag -eq $false) {
                  $targetDirectory = Split-Path $file -Parent

                  # Get all .lvproj files in the directory
                  $lvprojFiles = Get-ChildItem -Path $targetDirectory -Filter "*.lvproj" -File

                  if ($lvprojFiles.Count -gt 0) {

                    $flag = $true
                    $listOfLvfiles += $lvprojFiles.FullName

                  }
                  $file = $targetDirectory
                }
                              
              }
              $uniqueList = $listOfLvfiles | Get-Unique
              Write-Host $uniqueList 

              foreach ($lvprojFile in $uniqueList) 
              {
                          LabVIEWCLI -OperationName RunVI -VIPath "${{ github.workspace }}\src\Project file\OpenProject.vi" $lvprojFile
                          $directory = Split-Path $lvprojFile -Parent
                          $TestPath = "$directory\Tests"
                          echo "Test Path: $TestPath"
                          Find-ViFiles $TestPath
             }



             