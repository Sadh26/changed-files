name: CI

on:
  pull_request:
    branches:
      - main

  workflow_dispatch:

jobs:
  # ------------------------------------------------------------------------------------------------------------------------------------------------
  # Event `pull_request`: Compare the last commit of the main branch or last remote commit of the PR branch -> to the current commit of a PR branch.
  # ------------------------------------------------------------------------------------------------------------------------------------------------
  changed_files:
    runs-on: self-hosted
    name: Test changed-files
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0  # OR "2" -> To retrieve the preceding commit.

      - name: Get changed files in the src folder
        id: changed-files-specific
        uses: tj-actions/changed-files@v37
        with:
          files: src/**/*.vi  # Alternatively using: `docs/**` or `docs`
          separator: ","          

      - name: Run Tests
        run: |
            # Function to find test vi files
            function Find-ViFiles {
                param (
                    [string]$path
                )

                Get-ChildItem $path -Recurse | ForEach-Object {
                    if ($_.PSIsContainer) {
                        Find-ViFiles $_.FullName
                    }
                    elseif ($_.Extension -eq ".vi") {
                        $isFileExist = $true
                        Write-Output ("`n`nFound .vi file: " + $_.FullName)
                        Write-Output ("Running unit test file " + $_.FullName)
                        $output = g-cli --lv-ver 2020 $_.FullName
                        Write-Output ("$output")
                        if ($output -ne $null) {
                          $errorIn = "true"
                        }
                    }
                }
                if ($isFileExist -eq $false) {
                  Write-Output "No test files found"
                }
                if ($errorIn -eq "true") {
                  return $true
                }
                else {
                  return $false
                }
            }        
            echo "One or more files in the src folder has changed."
            echo "List all the files that have changed: ${{ steps.changed-files-specific.outputs.all_changed_files }}"

            $workspace = "${{ github.workspace }}"
            $workspace_path = $workspace.Replace("\", "/")

            $changed_file = "${{ steps.changed-files-specific.outputs.all_changed_files }}"
            $changedFiles = $changed_file -split ',' 
            
            $pathList = @()
            $isFileExist = $false

            foreach ($file in $changedFiles) {
                $directory = "$workspace_path/$file"
                echo "Directory: $directory"
                $directory = Split-Path $directory -Parent
                $flag = $false

                echo "Path List: $pathList"
                echo "Directory: $directory"

                  while ($flag -eq $false) {                 

                    # Get all .lvproj files in the directory
                    $lvprojFiles = Get-ChildItem -Path $directory -Filter "*.lvproj" -File
                     if ($lvprojFiles.Count -gt 0) {
                        $flag = $true
                        $pathList += $directory
                        $lvfilepath = Split-Path $lvprojFiles -Parent
                         }
                    if ($pathList -notcontains $lvfilepath)
                    {
                   
                        foreach ($lvprojFile in $lvprojFiles) {
                            Write-Host $lvprojFile.FullName
                            LabVIEWCLI -OperationName RunVI -VIPath "${{ github.workspace }}\src\Project file\OpenProject.vi" $lvprojFile.FullName
                            $TestPath = "$directory\Tests"
                            echo "Test Path: $TestPath"
                            Find-ViFiles $TestPath
                        }
                    }
                    }
                    $directory = Split-Path $directory -Parent
                    }
                
              }

              # $file_name = [System.IO.Path]::GetFileName($directory)
              # $file_path = [System.IO.Path]::GetDirectoryName($directory)
              # $filename_without_extension = [System.IO.Path]::GetFileNameWithoutExtension($file_name)
              # $proj_path= $file_path+"\"+$filename_without_extension+".lvproj"
              # echo $proj_path

              # LabVIEWCLI -OperationName RunVI -VIPath "${{ github.workspace }}\src\Project file\OpenProject.vi" "$proj_path"
              # $TestPath = "$(Split-Path $directory -Parent)\Tests"
              # echo "Test Path: $TestPath"



                        
 

